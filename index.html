<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TD5 - Application AR avec Three.js et WebXR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
        }

        /* Style du menu latéral */
        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            overflow-x: hidden;
            transition: 0.5s ease;
            padding-top: 60px;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.8);
        }

        .sidenav a {
            padding: 12px 12px 12px 32px;
            text-decoration: none;
            font-size: 20px;
            color: #e0e0e0;
            display: block;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            margin: 5px 0;
            font-weight: 500;
        }

        .sidenav a:hover {
            color: #ffffff;
            background: rgba(99, 102, 241, 0.2);
            border-left-color: #6366f1;
            padding-left: 40px;
        }

        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            color: #e0e0e0;
            cursor: pointer;
            transition: 0.3s;
        }

        .sidenav .closebtn:hover {
            color: #ffffff;
            transform: rotate(90deg);
        }

        /* Bouton menu hamburger */
        #menu-toggle {
            font-size: 28px;
            cursor: pointer;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 999;
            background: rgba(99, 102, 241, 0.9);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        #menu-toggle:hover {
            background: rgba(139, 92, 246, 0.95);
            transform: scale(1.05);
        }

        /* Bouton PLACE */
        #place-button {
            position: absolute;
            bottom: 20px;
            left: calc(50% - 75px);
            width: 150px;
            height: 45px;
            display: none;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #place-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
        }

        #place-button:active {
            transform: translateY(0);
        }

        /* Bouton ADD */
        #add-button {
            position: absolute;
            bottom: 75px;
            left: calc(50% - 75px);
            width: 150px;
            height: 45px;
            display: none;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #add-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
        }

        /* Bouton CLEAR */
        #clear-button {
            position: absolute;
            bottom: 130px;
            left: calc(50% - 75px);
            width: 150px;
            height: 45px;
            display: none;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);
        }

        /* Conteneur principal */
        #container {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        #content {
            width: 100%;
            height: 100%;
        }

        /* Compteur d'objets */
        #object-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            background: rgba(99, 102, 241, 0.9);
            padding: 12px 24px;
            border-radius: 10px;
            z-index: 998;
        }

        /* Instructions AR */
        .ar-info {
            position: absolute;
            top: 80px;
            right: 20px;
            color: white;
            font-size: 14px;
            background: rgba(99, 102, 241, 0.8);
            padding: 12px 16px;
            border-radius: 8px;
            z-index: 998;
            max-width: 250px;
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #menu-toggle {
                font-size: 24px;
                padding: 8px 14px;
            }

            #place-button, #add-button, #clear-button {
                width: 120px;
                height: 40px;
                font-size: 14px;
            }

            #place-button {
                left: calc(50% - 60px);
            }

            #add-button {
                left: calc(50% - 60px);
            }

            #clear-button {
                left: calc(50% - 60px);
            }

            #object-counter {
                font-size: 14px;
                padding: 10px 16px;
            }
        }
    </style>

    <!-- CDN jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <div id="content">
        <div id="mySidenav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <a class="ar-object" id="1" href="#">Chaise #1</a>
            <a class="ar-object" id="2" href="#">Chaise #2</a>
            <a class="ar-object" id="3" href="#">Table</a>
            <a class="ar-object" id="4" href="#">Lampe</a>
        </div>

        <div id="container" style="position: fixed;"></div>
        <button id="menu-toggle" onclick="openNav()">☰ Menu</button>
        <div id="object-counter">Objets: 0</div>
        <div class="ar-info">Visez une surface plane pour placer des objets</div>

        <button type="button" id="place-button">PLACER</button>
        <button type="button" id="add-button">AJOUTER</button>
        <button type="button" id="clear-button">EFFACER</button>
    </div>

    <script>
        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
        }
    </script>

    <!-- Import map pour Three.js -->
    <script type="importmap">
    {
        "imports": {
            "three": "./build/three.module.js",
            "three/addons/": "./jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from "three";
        import { ARButton } from "three/addons/webxr/ARButton.js";
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

        // Variables globales
        let container;
        let camera, scene, renderer;
        let reticle, pmremGenerator, current_object, controls, envmap;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let current_url = "1"; // Objet par défaut
        let touchDown, touchX, touchY, deltaX, deltaY;
        let objects = []; // Tableau pour stocker tous les objets
        let isARMode = false;

        init();
        animate();

        function init() {
            container = document.getElementById('container');

            // Scène
            scene = new THREE.Scene();

            // Caméra
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // Lumières
            var directionalLight = new THREE.DirectionalLight(0xdddddd, 1);
            directionalLight.position.set(0, 0, 1).normalize();
            scene.add(directionalLight);

            var ambientLight = new THREE.AmbientLight(0x222222);
            scene.add(ambientLight);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            // PMREMGenerator
            pmremGenerator = new THREE.PMREMGenerator(renderer);
            pmremGenerator.compileEquirectangularShader();

            // OrbitControls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.addEventListener('change', render);
            controls.minDistance = 2;
            controls.maxDistance = 10;
            controls.target.set(0, 0, -0.2);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Réticule (cercle AR)
            const geometry = new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial();
            reticle = new THREE.Mesh(geometry, material);
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // Configuration AR
            let options = {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
            };
            options.domOverlay = { root: document.getElementById('content') };
            document.body.appendChild(ARButton.createButton(renderer, options));

            // Événements tactiles
            renderer.domElement.addEventListener('touchstart', function(e) {
                e.preventDefault();
                touchDown = true;
                touchX = e.touches[0].pageX;
                touchY = e.touches[0].pageY;
            }, false);

            renderer.domElement.addEventListener('touchend', function(e) {
                e.preventDefault();
                touchDown = false;
            }, false);

            renderer.domElement.addEventListener('touchmove', function(e) {
                e.preventDefault();
                if (!touchDown) return;
                deltaX = e.touches[0].pageX - touchX;
                deltaY = e.touches[0].pageY - touchY;
                touchX = e.touches[0].pageX;
                touchY = e.touches[0].pageY;
                rotateObject();
            }, false);

            // Redimensionnement fenêtre
            window.addEventListener('resize', onWindowResize);

            // Charger l'objet par défaut
            setTimeout(() => {
                loadModel("1");
            }, 500);
        }

        // Gestionnaire de sélection d'objet
        $(".ar-object").click(function() {
            current_url = $(this).attr("id");
            if (!renderer.xr.isPresenting) {
                if (current_object != null) {
                    scene.remove(current_object);
                }
                loadModel(current_url);
            }
        });

        // Bouton PLACE
        $("#place-button").click(function() {
            arPlace();
        });

        // Bouton ADD (ajouter plusieurs objets)
        $("#add-button").click(function() {
            addObject();
        });

        // Bouton CLEAR (effacer tous les objets)
        $("#clear-button").click(function() {
            if (objects.length > 0) {
                if (confirm("Êtes-vous sûr de vouloir effacer tous les objets?")) {
                    clearScene();
                }
            }
        });

        // Quand on rentre en mode AR
        $("#ARButton").click(function() {
            isARMode = true;
            if (current_object) {
                current_object.visible = false;
            }
            document.querySelector(".ar-info").style.display = "block";
        });

        // Charger un modèle
        function loadModel(model) {
            new RGBELoader()
                .setDataType(THREE.HalfFloatType)
                .setPath('textures/')
                .load('photo_studio_01_1k.hdr', function(texture) {
                    envmap = pmremGenerator.fromEquirectangular(texture).texture;
                    texture.flipY = false;
                    texture.premultiplyAlpha = false;
                    scene.environment = envmap;
                    texture.dispose();
                    pmremGenerator.dispose();
                    render();

                    var loader = new GLTFLoader().setPath('3d/');
                    loader.load(model + ".glb", function(glb) {
                        current_object = glb.scene;
                        scene.add(current_object);
                        arPlace();

                        // Centrer l'objet
                        var box = new THREE.Box3();
                        box.setFromObject(current_object);
                        box.center(controls.target);
                        controls.update();
                        render();
                    });
                });
        }

        // Placer l'objet
        function arPlace() {
            if (reticle.visible && current_object) {
                current_object.position.setFromMatrixPosition(reticle.matrix);
                current_object.visible = true;
            }
        }

        // Ajouter un objet (cloner le courant)
        function addObject() {
            if (reticle.visible && current_object) {
                const newObject = current_object.clone();
                newObject.position.setFromMatrixPosition(reticle.matrix);
                newObject.visible = true;
                scene.add(newObject);
                objects.push(newObject);
                updateObjectCounter();
                console.log(`Objet ${objects.length} ajouté!`);
            }
        }

        // Effacer tous les objets
        function clearScene() {
            objects.forEach(obj => {
                scene.remove(obj);
                if (obj.geometry) obj.geometry.dispose();
                if (obj.material) {
                    if (Array.isArray(obj.material)) {
                        obj.material.forEach(mat => mat.dispose());
                    } else {
                        obj.material.dispose();
                    }
                }
            });
            objects = [];
            updateObjectCounter();
            console.log("Scène effacée!");
        }

        // Mettre à jour le compteur
        function updateObjectCounter() {
            document.getElementById("object-counter").textContent = "Objets: " + objects.length;
        }

        // Rotation tactile
        function rotateObject() {
            if (current_object && reticle.visible) {
                current_object.rotation.y += deltaX / 100;
            }
        }

        // Redimensionnement fenêtre
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Rendu
        function render() {
            renderer.render(scene, camera);
        }

        // Boucle animation
        function animate() {
            renderer.setAnimationLoop(renderLoop);
        }

        function renderLoop(timestamp, frame) {
            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (hitTestSourceRequested === false) {
                    session.requestReferenceSpace('viewer').then(function(referenceSpace) {
                        session.requestHitTestSource({ space: referenceSpace }).then(function(source) {
                            hitTestSource = source;
                        });
                    });

                    session.addEventListener('end', function() {
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                        reticle.visible = false;
                        isARMode = false;

                        if (current_object) {
                            var box = new THREE.Box3();
                            box.setFromObject(current_object);
                            box.center(controls.target);
                        }

                        document.getElementById("place-button").style.display = "none";
                        document.getElementById("add-button").style.display = "none";
                        document.getElementById("clear-button").style.display = "none";
                        document.querySelector(".ar-info").style.display = "none";
                    });

                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);

                    if (hitTestResults.length) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);

                        document.getElementById("place-button").style.display = "block";
                        document.getElementById("add-button").style.display = "block";
                        if (objects.length > 0) {
                            document.getElementById("clear-button").style.display = "block";
                        }
                    } else {
                        reticle.visible = false;
                        document.getElementById("place-button").style.display = "none";
                        document.getElementById("add-button").style.display = "none";
                        document.getElementById("clear-button").style.display = "none";
                    }
                }
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>